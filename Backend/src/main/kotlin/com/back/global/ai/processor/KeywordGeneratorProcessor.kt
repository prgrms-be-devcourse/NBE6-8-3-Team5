package com.back.global.ai.processor

import com.back.domain.news.common.dto.KeywordGenerationReqDto
import com.back.domain.news.common.dto.KeywordGenerationResDto
import com.back.domain.news.common.dto.KeywordWithType
import com.back.domain.news.common.enums.KeywordType
import com.fasterxml.jackson.databind.ObjectMapper
import org.slf4j.LoggerFactory
import org.springframework.ai.chat.model.ChatResponse

/**
 * ë‰´ìŠ¤ ì œëª©ê³¼ ë³¸ë¬¸ì„ ê¸°ë°˜ ìƒì„¸ í€´ì¦ˆ 3ê°œë¥¼ ìƒì„±í•˜ëŠ” AI ìš”ì²­ Processor ì…ë‹ˆë‹¤.
 */
class KeywordGeneratorProcessor(
    private val keywordGenerationReqDto: KeywordGenerationReqDto,
    private val objectMapper: ObjectMapper
) : AiRequestProcessor<KeywordGenerationResDto> {

    companion object {
        private val log = LoggerFactory.getLogger(NewsAnalysisProcessor::class.java)
    }

    override fun buildPrompt(): String {
        return """
            Task: ì˜¤ëŠ˜ ë‰´ìŠ¤ ìˆ˜ì§‘ì„ ìœ„í•œ ì¹´í…Œê³ ë¦¬ë³„ í‚¤ì›Œë“œë¥¼ ìƒì„±í•˜ì„¸ìš”.
            
            âš ï¸ ì‚¬ì „ ì¡°ì‚¬ ìš”ì²­ - í‚¤ì›Œë“œ ìƒì„± ì „ì— ë‹¤ìŒ ì‚¬í•­ë“¤ì„ ì›¹ ê²€ìƒ‰ì„ í†µí•´ ë¨¼ì € íŒŒì•…í•´ì£¼ì„¸ìš”:
            1. ë„¤ì´ë²„ ë‰´ìŠ¤ ë©”ì¸ì˜ í˜„ì¬ ì£¼ìš” í—¤ë“œë¼ì¸ (ìµœê·¼ 2-3ì‹œê°„ ë‚´)
            2. êµ¬ê¸€ íŠ¸ë Œë“œ í•œêµ­ ë˜ëŠ” ë‹¤ìŒ/ì¤Œ ë“±ì˜ ì‹¤ì‹œê°„ ì´ìŠˆ í™•ì¸
            3. ê° ì¹´í…Œê³ ë¦¬ë³„ ìµœì‹  ì£¼ìš” ì´ìŠˆ:
            - ì •ì¹˜: êµ­íšŒ/ì •ë¶€ ìµœì‹  ë™í–¥, ì •ì±… ë°œí‘œ
            - ê²½ì œ: ì¦ì‹œ/ë¶€ë™ì‚°/ê¸ˆìœµ ì •ì±… ìµœì‹  ì†Œì‹
            - ì‚¬íšŒ: ìµœê·¼ ì‚¬ê±´ì‚¬ê³ , ì‚¬íšŒì  ì´ìŠˆ
            - ë¬¸í™”: ì—°ì˜ˆ/ìŠ¤í¬ì¸ /ì—”í„°í…Œì¸ë¨¼íŠ¸ ì£¼ìš” ë‰´ìŠ¤
            - IT: ê¸°ìˆ /ê²Œì„/í”Œë«í¼ ê´€ë ¨ ìµœì‹  ì´ìŠˆ
            4. ì˜¤ëŠ˜ ì˜ˆì •ëœ ì£¼ìš” ì¼ì •ì´ë‚˜ ë°œí‘œ (ì •ë¶€, ê¸°ì—…, ê¸°ê´€)
            
            ì¶”ê°€ í™•ì¸ì‚¬í•­:
            - ìµœê·¼ 3ì¼ê°„ ì§€ì†ì ìœ¼ë¡œ ì–¸ê¸‰ë˜ëŠ” í‚¤ì›Œë“œë“¤
            - ì£¼ìš” ì–¸ë¡ ì‚¬(ì¡°ì„ ì¼ë³´, ì¤‘ì•™ì¼ë³´ ë“±) ë©”ì¸ í—¤ë“œë¼ì¸
            - êµ­ì œ ë‰´ìŠ¤ ì¤‘ êµ­ë‚´ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆëŠ” ì´ìŠˆ
            - ê³„ì ˆì /ì‹œê¸°ì  íŠ¹ì„± (íœ´ê°€ì² , í­ì—¼, ì¥ë§ˆ ë“±)
            - SNSë‚˜ ì˜¨ë¼ì¸ ì»¤ë®¤ë‹ˆí‹°ì—ì„œ í™”ì œê°€ ë˜ëŠ” ì´ìŠˆ
            
            âš ï¸ ì¤‘ìš”: ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹¤ì œ í˜„ì¬ ìƒí™©ì„ ë°˜ì˜í•œ í‚¤ì›Œë“œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.
            
            ëª©ì :
            - ë„¤ì´ë²„ ë‰´ìŠ¤ ê²€ìƒ‰ APIì—ì„œ íš¨ê³¼ì ìœ¼ë¡œ ê²€ìƒ‰ë˜ëŠ” í‚¤ì›Œë“œ ìƒì„±
            - ì‹¤ì œ ë‰´ìŠ¤ ì œëª©ì— ìì£¼ ì‚¬ìš©ë˜ëŠ” ì‹¤ìš©ì ì¸ í‚¤ì›Œë“œ ì„ íƒ
            - ê° í‚¤ì›Œë“œì˜ ì„±ê²©ì— ë§ëŠ” ì •í™•í•œ íƒ€ì… ë¶„ë¥˜
            
            âš ï¸ ì¤‘ìš”í•œ ì œì•½ì‚¬í•­:
            - í‚¤ì›Œë“œëŠ” ë‰´ìŠ¤ ì œëª©ì— ì‹¤ì œë¡œ í¬í•¨ë  ìˆ˜ ìˆëŠ” ë‹¨ì–´ì—¬ì•¼ í•©ë‹ˆë‹¤
            - 2-4ê¸€ìì˜ ë‹¨ìˆœí•˜ê³  ëª…í™•í•œ í‚¤ì›Œë“œ (ì˜ˆ: "AI", "ë¶€ë™ì‚°", "ì„ ê±°")
            - ì‹¤ì œ ê¸°ìë“¤ì´ ì œëª©ì— ì‚¬ìš©í•  ë²•í•œ í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ì„¸ìš”
            
            í˜„ì¬ ë‚ ì§œ: ${keywordGenerationReqDto.currentDate}
            
            âš ï¸ ì‹¤ì‹œê°„ ìƒí™© ë°˜ì˜ ì§€ì¹¨:
            **ì›¹ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ** ë‹¤ìŒì„ ìš°ì„  ê³ ë ¤:
            1. í˜„ì¬ ë„¤ì´ë²„ ë‰´ìŠ¤ ë©”ì¸ í—¤ë“œë¼ì¸ì˜ í•µì‹¬ í‚¤ì›Œë“œ
            2. êµ¬ê¸€ íŠ¸ë Œë“œë‚˜ ë‹¤ë¥¸ í”Œë«í¼ì˜ ê¸‰ìƒìŠ¹ í‚¤ì›Œë“œ
            3. ì£¼ìš” ì–¸ë¡ ì‚¬ ë©”ì¸ í˜ì´ì§€ì˜ ê³µí†µ ì´ìŠˆ
            4. ìµœê·¼ 7ì¼ê°„ ì§€ì†ì ìœ¼ë¡œ ë³´ë„ë˜ëŠ” ì´ìŠˆ
            5. ê³„ì ˆì  íŠ¹ì„± ë° ì˜¤ëŠ˜ ì˜ˆì •ëœ ì£¼ìš” ì´ë²¤íŠ¸
            6. êµ­ì œì  ì´ìŠˆê°€ êµ­ë‚´ì— ë¯¸ì¹˜ëŠ” ì˜í–¥
            7. ìƒˆë¡œìš´ ì •ì±… ì‹œí–‰ì´ë‚˜ ì œë„ ë³€í™”
            
            [ì‹¤ì‹œê°„ íŠ¸ë Œë“œ ê³ ë ¤ì‚¬í•­]
            - ì •ì¹˜: í˜„ì¬ êµ­íšŒ ì¼ì •, ì„ ê±° ê´€ë ¨ ì´ìŠˆ, ì •ì±… ë°œí‘œ
            - ê²½ì œ: ê¸ˆë¦¬ ê²°ì •, ë¶€ë™ì‚° ì •ì±…, ì£¼ìš” ê¸°ì—… ì‹¤ì  ë°œí‘œ
            - ì‚¬íšŒ: ì‚¬ê±´ì‚¬ê³ , ë‚ ì”¨ ì´ìŠˆ, êµìœ¡ ì •ì±…
            - ë¬¸í™”: ìƒˆ ì˜í™”/ë“œë¼ë§ˆ ê°œë´‰, ìŠ¤í¬ì¸  ì‹œì¦Œ, KíŒ í™œë™
            - IT: ìƒˆë¡œìš´ ê¸°ìˆ  ë°œí‘œ, ê²Œì„ ì¶œì‹œ, ë³´ì•ˆ ì´ìŠˆ
            
            [í‚¤ì›Œë“œ ìƒì„± ë° íƒ€ì… ë¶„ë¥˜]
            - ê° ì¹´í…Œê³ ë¦¬ë‹¹ ì •í™•íˆ 2ê°œì˜ í‚¤ì›Œë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤
            - ê° í‚¤ì›Œë“œì˜ ì‹¤ì œ íŠ¹ì„±ì„ ë¶„ì„í•˜ì—¬ ì ì ˆí•œ íƒ€ì…ì„ ë¶€ì—¬í•©ë‹ˆë‹¤
            - ì‹œì˜ì„±ì´ ë†’ì€ í‚¤ì›Œë“œë¥¼ ìš°ì„ ì ìœ¼ë¡œ ì„ íƒí•˜ì„¸ìš”
            
            [ì¹´í…Œê³ ë¦¬ë³„ ìš”êµ¬ì‚¬í•­]
            - SOCIETY: ì‚¬íšŒ ì´ìŠˆ ê´€ë ¨ (ìµœê·¼ ì‚¬ê±´, ì •ì±… ë³€í™”, ì‚¬íšŒ í˜„ìƒ)
            - ECONOMY: ê²½ì œ ê´€ë ¨ (ì‹œì¥ ë™í–¥, ì •ì±… ë°œí‘œ, ê¸°ì—… ì´ìŠˆ)
            - POLITICS: ì •ì¹˜ ê´€ë ¨ (êµ­íšŒ í™œë™, ì •ì±… ë…¼ì˜, ì„ ê±° ì´ìŠˆ)
            - CULTURE: ë¬¸í™”/ìƒí™œ ê´€ë ¨ (ì—”í„°í…Œì¸ë¨¼íŠ¸, ìŠ¤í¬ì¸ , ë¼ì´í”„ìŠ¤íƒ€ì¼)
            - IT: IT/ê³¼í•™ê¸°ìˆ  (ì‹ ê¸°ìˆ , ê²Œì„, ë³´ì•ˆ, í”Œë«í¼ ì´ìŠˆ)
            
            [í‚¤ì›Œë“œ íƒ€ì… ë¶„ë¥˜ ê¸°ì¤€]
            - BREAKING: ìµœê·¼ 1-3ì¼ ë‚´ ê¸‰ë¶€ìƒí•œ ì´ìŠˆ, ê¸´ê¸‰ ì‚¬ê±´, ì†ë³´ì„± í‚¤ì›Œë“œ
            - ONGOING: í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì§€ì†ì  ê´€ì‹¬ì‚¬, 1-2ì£¼ê°„ í™”ì œê°€ ëœ ì´ìŠˆ
            - GENERAL: í‰ìƒì‹œì—ë„ ê¾¸ì¤€íˆ ë‹¤ë¤„ì§€ëŠ” ì¼ë°˜ì  ì£¼ì œ
            - SEASONAL: í˜„ì¬ ì‹œê¸°(ê³„ì ˆ/ì‹œì )ì™€ ê°•í•˜ê²Œ ì—°ê´€ëœ í‚¤ì›Œë“œ
            
            [ê¸°ì¡´ ë ˆí¬ì§€í† ë¦¬ í‚¤ì›Œë“œ í™œìš©]
            ë‹¤ìŒì€ ìµœê·¼ ì‚¬ìš©ëœ í‚¤ì›Œë“œë“¤ê³¼ ê·¸ íƒ€ì…ì…ë‹ˆë‹¤: ${keywordGenerationReqDto.recentKeywordsWithTypes}
            
            âš ï¸ ë ˆí¬ì§€í† ë¦¬ í‚¤ì›Œë“œ ì¬í™œìš© ê·œì¹™:
            1. ONGOING íƒ€ì… í‚¤ì›Œë“œ: ì—¬ì „íˆ ì§„í–‰ ì¤‘ì´ê³  ì¤‘ìš”í•˜ë‹¤ë©´ ìš°ì„ ì ìœ¼ë¡œ ì¬ì„ íƒ
            2. BREAKING íƒ€ì… í‚¤ì›Œë“œ: 3ì¼ ì´ë‚´ë¼ë©´ ê³„ì† BREAKING, ê·¸ ì´í›„ëŠ” ONGOINGìœ¼ë¡œ ì „í™˜ ê³ ë ¤
            3. ê¸°ì¡´ í‚¤ì›Œë“œê°€ ìƒˆë¡œìš´ ì „ê°œë‚˜ ì´ìŠˆë¡œ ë‹¤ì‹œ ì£¼ëª©ë°›ëŠ”ë‹¤ë©´ ì ê·¹ í¬í•¨
            4. ê°™ì€ í‚¤ì›Œë“œë¼ë„ ìƒí™© ë³€í™”ì— ë”°ë¼ íƒ€ì… ì¡°ì • ê°€ëŠ¥
            
            [ì œì™¸ í‚¤ì›Œë“œ]
            ë‹¤ìŒ í‚¤ì›Œë“œë“¤ì€ ìµœê·¼ ê³¼ë„í•˜ê²Œ ì‚¬ìš©ë˜ì–´ ì œì™¸í•´ì£¼ì„¸ìš”: ${keywordGenerationReqDto.excludeKeywords}
            
            âš ï¸ ì˜ˆì™¸: ì œì™¸ í‚¤ì›Œë“œë¼ë„ ì¤‘ëŒ€í•œ ìƒˆë¡œìš´ ì‚¬ê±´ì´ë‚˜ ì™„ì „íˆ ë‹¤ë¥¸ ì „ê°œê°€ ìˆë‹¤ë©´ í¬í•¨ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            
            [ì‹œê¸°ë³„ íŠ¹ì„± ë°˜ì˜]
            í˜„ì¬ ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ:
            - 7-8ì›”: ì—¬ë¦„íœ´ê°€, ì¥ë§ˆ, í­ì—¼, ì˜¬ë¦¼í”½/ìŠ¤í¬ì¸  ì‹œì¦Œ
            - 9-10ì›”: ì¶”ì„, êµ­ì •ê°ì‚¬, 3ë¶„ê¸° ì‹¤ì 
            - 11-12ì›”: ìˆ˜ëŠ¥, ì—°ë§ì •ì‚°, ë‚´ë…„ ì˜ˆì‚°
            - 1-2ì›”: ì„¤ë‚ , ìƒˆí•´ ì •ì±…, ì¡¸ì—…/ì…í•™
            - 3-4ì›”: ë²šê½ƒ, ìƒˆ í•™ê¸°, 1ë¶„ê¸° ì‹¤ì 
            - 5-6ì›”: ì–´ë¦°ì´ë‚ , ì–´ë²„ì´ë‚ , ìƒë°˜ê¸° ê²°ì‚°
            
            ğŸ“Š í‚¤ì›Œë“œ ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸:
            1. **ì‹¤ì‹œê°„ í™•ì¸**: í˜„ì¬ ë„¤ì´ë²„ ë‰´ìŠ¤ì—ì„œ ì‹¤ì œ ê²€ìƒ‰ë˜ëŠ”ê°€?
            2. **ì œëª© ì í•©ì„±**: ê¸°ìê°€ ì œëª©ì— ì‚¬ìš©í•  ë²•í•œ ë‹¨ì–´ì¸ê°€?
            3. **í˜„ì¬ ê´€ì‹¬ë„**: ì›¹ ê²€ìƒ‰ ê²°ê³¼ ê¸°ì¤€ í˜„ì¬ í™”ì œì„±ì´ ë†’ì€ê°€?
            4. **í˜•íƒœ ì í•©ì„±**: 2-4ê¸€ìì˜ ê°„ê²°í•œ í˜•íƒœì¸ê°€?
            5. **ì¹´í…Œê³ ë¦¬ ì í•©ì„±**: í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ì í•©í•œ í‚¤ì›Œë“œì¸ê°€?
            6. **ì¤‘ë³µì„± ê²€í† **: ê¸°ì¡´ ë ˆí¬ì§€í† ë¦¬ë‚˜ ì œì™¸ í‚¤ì›Œë“œì™€ ê²¹ì¹˜ì§€ ì•ŠëŠ”ê°€?
            
            ì‘ë‹µ í˜•ì‹:
            ë°˜ë“œì‹œ ì•„ë˜ì˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. ì„¤ëª… ì—†ì´ JSONë§Œ ë°˜í™˜í•˜ì„¸ìš”.
            
            ```json
            {
              "society": [
                {"keyword": "êµìœ¡", "keywordType": "GENERAL"},
                {"keyword": "ì•ˆì „", "keywordType": "ONGOING"}
              ],
              "economy": [
                {"keyword": "ê¸ˆë¦¬", "keywordType": "BREAKING"},
                {"keyword": "ë¶€ë™ì‚°", "keywordType": "ONGOING"}
              ],
              "politics": [
                {"keyword": "êµ­íšŒ", "keywordType": "ONGOING"},
                {"keyword": "ì„ ê±°", "keywordType": "SEASONAL"}
              ],
              "culture": [
                {"keyword": "ì˜í™”", "keywordType": "GENERAL"},
                {"keyword": "ì¶•ì œ", "keywordType": "SEASONAL"}
              ],
              "it": [
                {"keyword": "AI", "keywordType": "BREAKING"},
                {"keyword": "ë°˜ë„ì²´", "keywordType": "ONGOING"}
              ]
            }
            ```
            
            """.trimIndent()
    }

    // AI ì‘ë‹µì„ íŒŒì‹±í•˜ì—¬ KeywordGenerationResDto ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
    override fun parseResponse(response: ChatResponse): KeywordGenerationResDto {
        val text = response.result?.output?.text?.takeIf { it.isNotBlank() }
            ?: return createDefaultKeywords()

        val cleanedJson = cleanResponse(text)

        return runCatching {
            objectMapper.readValue(cleanedJson, KeywordGenerationResDto::class.java)
        }.onFailure { e ->
            println(">>> JSON parsing failed: ${e.message}")
            e.printStackTrace()
        }.getOrElse {
            createDefaultKeywords()
        }
    }

    // AI ì‘ë‹µ ì •ë¦¬ - ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±°
    private fun cleanResponse(text: String): String {
        return text.trim()
            .replace(Regex("(?s)```json\\s*(.*?)\\s*```"), "$1")
            .replace(Regex("```"), "")
            .trim()
    }


    private fun createDefaultKeywords(): KeywordGenerationResDto {
        fun createKeywords(vararg keywords: String) = keywords.map {
            KeywordWithType(it, KeywordType.GENERAL)
        }
        log.debug("í‚¤ì›Œë“œ ìƒì„± ì‹¤íŒ¨ : defaultkeywords ë°˜í™˜")

        return KeywordGenerationResDto(
            society = createKeywords("ì‚¬íšŒ", "êµìœ¡"),
            economy = createKeywords("ê²½ì œ", "ì‹œì¥"),
            politics = createKeywords("ì •ì¹˜", "ì •ë¶€"),
            culture = createKeywords("ë¬¸í™”", "ì˜ˆìˆ "),
            it = createKeywords("ê¸°ìˆ ", "IT")
        )
    }
}
